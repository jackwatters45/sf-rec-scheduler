#!/bin/bash

# Parse command line arguments for --dry-run
DRY_RUN=false
for arg in "$@"; do
  if [[ "$arg" == "--dry-run" ]]; then
    DRY_RUN=true
  fi
done

# Check if we're on main/master
branch=$(git rev-parse --abbrev-ref HEAD)
if [[ "$branch" != "main" && "$branch" != "master" ]]; then
  exit 0
fi

# Check if .env exists
if [ ! -f .env ]; then
  echo "Error: .env file not found"
  exit 1
fi

# Check if flyctl is installed
if ! command -v flyctl &>/dev/null; then
  echo "Error: flyctl not found. Please install Fly.io CLI first."
  exit 1
fi

# Check if user is logged into fly
if ! flyctl auth whoami &>/dev/null; then
  echo "Error: Not logged into Fly.io. Please run 'fly auth login' first."
  exit 1
fi

echo "Push completed successfully. Would you like to sync your .env secrets to Fly.io?"
echo "The following secrets will be synced:"
while IFS= read -r line || [ -n "$line" ]; do
  # Skip empty lines and comments
  if [[ -n "$line" && ! "$line" =~ ^[[:space:]]*# ]]; then
    # Remove any surrounding quotes from the value
    line=$(echo "$line" | sed -E "s/['\"]//g")
    echo "  $line"
  fi
done <.env

if [ "$DRY_RUN" = true ]; then
  echo "Dry run complete. No changes were made."
  exit 0
fi

# Ask for confirmation with clear prompt
echo
echo -n "Sync these secrets to Fly.io? (y/N): "
read -r REPLY
echo

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Sync cancelled."
  exit 0
fi

echo "Syncing .env to Fly.io secrets..."

# Read .env file and set each non-empty, non-comment line as a secret
while IFS= read -r line || [ -n "$line" ]; do
  # Skip empty lines and comments
  if [[ -n "$line" && ! "$line" =~ ^[[:space:]]*# ]]; then
    # Remove any surrounding quotes from the value
    line=$(echo "$line" | sed -E "s/['\"]//g")
    echo "Setting secret: $line"
    if ! flyctl secrets set "$line" &>/dev/null; then
      echo "Error setting secret: $line"
      exit 1
    fi
  fi
done <.env

echo "Successfully synced secrets to Fly.io"
